<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Manager Voley</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

    <nav class="bg-white shadow mb-6">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Panel Manager</h1>
            <button id="logout-btn" class="text-sm text-red-600 hover:text-red-800 font-medium">Cerrar Sesión</button>
        </div>
    </nav>

    <div class="container mx-auto max-w-2xl p-4">

        <div id="alert-container" class="mb-4"></div>

        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4 text-gray-800">Crear Nuevo Partido</h2>
            
            <div class="mb-4">
                <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                <select id="category-select" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Selecciona una categoría...</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="team1-select" class="block text-sm font-medium text-gray-700 mb-1">Local</label>
                    <select id="team1-select" disabled class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 disabled:bg-gray-100">
                        <option value="">Primero elige categoría</option>
                    </select>
                </div>
                <div>
                    <label for="team2-select" class="block text-sm font-medium text-gray-700 mb-1">Visitante</label>
                    <select id="team2-select" disabled class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 disabled:bg-gray-100">
                        <option value="">Primero elige categoría</option>
                    </select>
                </div>
            </div>
            
            <button id="create-game-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
                Crear Partido
            </button>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Partidos En Curso / Próximos</h2>
            <button id="refresh-btn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Refrescar</button>
        </div>

        <div id="games-list" class="space-y-4">
            <p class="text-gray-500 text-center py-4">Cargando partidos...</p>
        </div>
        
    </div>

    <script>
        const categorySelect = document.getElementById('category-select');
        const team1Select = document.getElementById('team1-select');
        const team2Select = document.getElementById('team2-select');
        const createGameBtn = document.getElementById('create-game-btn');
        const gamesList = document.getElementById('games-list');
        const alertContainer = document.getElementById('alert-container');

        // --- Funciones API ---

        async function loadCategories() {
            try {
                const res = await fetch('/manager/categories');
                if (!res.ok) throw new Error('Error cargando categorías');
                const cats = await res.json();
                
                categorySelect.innerHTML = '<option value="">Selecciona una categoría...</option>';
                cats.forEach(c => {
                    categorySelect.add(new Option(c.name, c.id));
                });
            } catch (e) { showAlert(e.message, 'danger'); }
        }

        async function loadTeams(categoryId) {
            team1Select.innerHTML = '<option value="">Cargando...</option>';
            team2Select.innerHTML = '<option value="">Cargando...</option>';
            team1Select.disabled = true;
            team2Select.disabled = true;

            try {
                const res = await fetch(`/manager/teams?category_id=${categoryId}`);
                if (!res.ok) throw new Error('Error cargando equipos');
                const teams = await res.json();

                team1Select.innerHTML = '<option value="">Selecciona Equipo</option>';
                team2Select.innerHTML = '<option value="">Selecciona Equipo</option>';
                
                teams.forEach(t => {
                    team1Select.add(new Option(t.name, t.id));
                    team2Select.add(new Option(t.name, t.id));
                });
                
                team1Select.disabled = false;
                team2Select.disabled = false;
            } catch (e) { showAlert(e.message, 'danger'); }
        }

        async function createGame() {
            const category_id = categorySelect.value;
            const team1_id = team1Select.value;
            const team2_id = team2Select.value;

            if (!category_id || !team1_id || !team2_id) return showAlert('Completa todos los campos', 'warning');
            if (team1_id === team2_id) return showAlert('Los equipos deben ser distintos', 'warning');

            createGameBtn.disabled = true; createGameBtn.textContent = 'Creando...';

            try {
                const res = await fetch('/manager/games', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ team1_id, team2_id, category_id })
                });
                if (!res.ok) throw new Error('Error al crear partido');
                
                showAlert('Partido creado exitosamente', 'success');
                team1Select.value = ""; team2Select.value = "";
                loadActiveGames();
            } catch (e) { showAlert(e.message, 'danger');
            } finally { createGameBtn.disabled = false; createGameBtn.textContent = 'Crear Partido'; }
        }

        async function loadActiveGames() {
            gamesList.innerHTML = '<p class="text-gray-500 text-center">Cargando...</p>';
            try {
                const res = await fetch('/manager/games/list');
                const games = await res.json();

                if (games.length === 0) {
                    gamesList.innerHTML = '<div class="text-center text-gray-500 py-8">No hay partidos activos.</div>';
                    return;
                }

                gamesList.innerHTML = '';
                games.forEach(game => {
                    // Tarjeta simple de resumen
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center';
                    card.innerHTML = `
                        <div>
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wide mb-1">
                                ${game.category_name || 'Sin Categoría'}
                            </div>
                            <div class="text-lg font-bold text-gray-800">
                                ${game.team1_name} <span class="text-gray-400 text-sm px-1">vs</span> ${game.team2_name}
                            </div>
                            <div class="text-sm text-gray-500 mt-1">
                                ${game.status === 'live' 
                                    ? `<span class="text-red-600 font-bold">● EN VIVO</span> - Set ${game.current_set_number}` 
                                    : 'Próximo'}
                            </div>
                        </div>
                        <div>
                            <a href="/manager/game?id=${game.id}" 
                               class="block bg-gray-800 text-white text-sm font-medium py-2 px-4 rounded hover:bg-black transition">
                                Gestionar &rarr;
                            </a>
                        </div>
                    `;
                    gamesList.appendChild(card);
                });

            } catch (e) { gamesList.innerHTML = '<p class="text-red-500">Error de carga</p>'; }
        }

        // --- Listeners ---
        categorySelect.addEventListener('change', (e) => {
            if (e.target.value) loadTeams(e.target.value);
            else {
                team1Select.innerHTML = '<option value="">Primero elige categoría</option>';
                team1Select.disabled = true;
                // ... (mismo para team2)
            }
        });
        createGameBtn.addEventListener('click', createGame);
        document.getElementById('refresh-btn').addEventListener('click', loadActiveGames);
        
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        });

        // Init
        loadCategories();
        loadActiveGames();

        function showAlert(msg, type) {
            const color = type === 'danger' ? 'red' : type === 'success' ? 'green' : 'yellow';
            alertContainer.innerHTML = `<div class="bg-${color}-100 border border-${color}-400 text-${color}-700 px-4 py-3 rounded relative">${msg}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 3000);
        }
    </script>
</body>
</html>