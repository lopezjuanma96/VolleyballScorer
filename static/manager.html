<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager - Torneo de Voley</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-2xl p-4 mt-10">

        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Manager de Partidos</h1>

        <div id="alert-container" class="mb-4"></div>

        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Autenticación</h2>
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                <input type="text" id="username" value="manager" 
                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                <input type="password" id="password" value="voley123"
                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <p class="text-xs text-gray-500 mt-2">Esto se usará para todas las peticiones de API.</p>
        </div>

        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Crear Nuevo Partido</h2>
            
            <div class="mb-4">
                <label for="team1-select" class="block text-sm font-medium text-gray-700 mb-1">Equipo Local</label>
                <select id="team1-select" 
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Cargando equipos...</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label for="team2-select" class="block text-sm font-medium text-gray-700 mb-1">Equipo Visitante</label>
                <select id="team2-select" 
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Cargando equipos...</option>
                </select>
            </div>
            
            <button id="create-game-btn" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                Crear Partido
            </button>
        </div>
        
    </div>

    <script>
        // --- Constantes del DOM ---
        const team1Select = document.getElementById('team1-select');
        const team2Select = document.getElementById('team2-select');
        const createGameBtn = document.getElementById('create-game-btn');
        const alertContainer = document.getElementById('alert-container');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');

        // --- Headers de Autenticación ---
        function getAuthHeaders() {
            const user = usernameInput.value;
            const pass = passwordInput.value;
            const basicAuth = 'Basic ' + btoa(user + ':' + pass);
            return {
                'Content-Type': 'application/json',
                'Authorization': basicAuth
            };
        }

        // --- Funciones de API ---
        async function loadTeams() {
            try {
                const response = await fetch('/manager/teams', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    showAlert('Error de autenticación. Revisa usuario y contraseña.', 'danger');
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Error ${response.status}: No se pudieron cargar los equipos.`);
                }

                const teams = await response.json(); 

                team1Select.innerHTML = '<option value="">Selecciona un equipo</option>';
                team2Select.innerHTML = '<option value="">Selecciona un equipo</option>';

                teams.forEach(team => {
                    const option1 = new Option(`${team.name} ${team.flag || ''}`, team.id);
                    const option2 = new Option(`${team.name} ${team.flag || ''}`, team.id);
                    team1Select.add(option1);
                    team2Select.add(option2);
                });
                
                // No mostramos alerta de éxito, es mejor que simplemente funcione
                // showAlert('Equipos cargados correctamente.', 'success');

            } catch (error) {
                console.error('Error en loadTeams:', error);
                showAlert(error.message, 'danger');
            }
        }

        async function createGame() {
            const team1_id = team1Select.value;
            const team2_id = team2Select.value;

            if (!team1_id || !team2_id) {
                showAlert('Debes seleccionar ambos equipos.', 'warning');
                return;
            }
            if (team1_id === team2_id) {
                showAlert('Un equipo no puede jugar contra sí mismo.', 'warning');
                return;
            }

            createGameBtn.disabled = true;
            createGameBtn.textContent = 'Creando...';

            const body = JSON.stringify({
                team1_id: team1_id,
                team2_id: team2_id
            });

            try {
                const response = await fetch('/manager/games', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: body
                });

                const responseData = await response.json(); 

                if (!response.ok) {
                    throw new Error(responseData.detail || `Error ${response.status}`);
                }
                
                const game = responseData;
                showAlert(`Partido creado: ${game.team1_name} vs ${game.team2_name}`, 'success');
                
                team1Select.value = "";
                team2Select.value = "";

            } catch (error) {
                console.error('Error en createGame:', error);
                showAlert(error.message, 'danger');
            } finally {
                createGameBtn.disabled = false;
                createGameBtn.textContent = 'Crear Partido';
            }
        }

        // --- Helper de UI ---
        function showAlert(message, type = 'info') {
            let bgColor, borderColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100'; borderColor = 'border-green-400'; textColor = 'text-green-700';
                    break;
                case 'danger':
                    bgColor = 'bg-red-100'; borderColor = 'border-red-400'; textColor = 'text-red-700';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-100'; borderColor = 'border-yellow-400'; textColor = 'text-yellow-700';
                    break;
                default:
                    bgColor = 'bg-blue-100'; borderColor = 'border-blue-400'; textColor = 'text-blue-700';
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = `${bgColor} ${borderColor} ${textColor} border px-4 py-3 rounded relative`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                <span class="block sm:inline">${message}</span>
                <span class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.remove();">
                    <svg class="fill-current h-6 w-6 ${textColor}" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l3.029-2.651-3.03-2.651a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.03a1.2 1.2 0 1 1 1.697 1.697l-3.03 2.651 3.03 2.651a1.2 1.2 0 0 1 0 1.698z"/></svg>
                </span>
            `;
            
            alertContainer.innerHTML = ''; // Limpiar alertas anteriores
            alertContainer.append(alertDiv);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', loadTeams);
        createGameBtn.addEventListener('click', createGame);
    </script>
</body>
</html>