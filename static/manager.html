<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager - Torneo de Voley</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-2xl p-4 mt-10">

        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Manager de Partidos</h1>

        <div id="alert-container" class="mb-4"></div>

        <details class="bg-white shadow-md rounded-lg p-6 mb-6">
            <summary class="text-xl font-semibold cursor-pointer">Autenticación</summary>
            <div class="mt-4">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <input type="text" id="username" value="manager" 
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="password" value="voley123"
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </details>

        <details class="bg-white shadow-md rounded-lg p-6 mb-6">
            <summary class="text-xl font-semibold cursor-pointer">Crear Nuevo Partido</summary>
            <div class="mt-4">
                <div class="mb-4">
                    <label for="team1-select" class="block text-sm font-medium text-gray-700 mb-1">Equipo Local</label>
                    <select id="team1-select" 
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Cargando equipos...</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="team2-select" class="block text-sm font-medium text-gray-700 mb-1">Equipo Visitante</label>
                    <select id="team2-select" 
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Cargando equipos...</option>
                    </select>
                </div>
                
                <button id="create-game-btn" 
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Crear Partido
                </button>
            </div>
        </details>

        <div id="manage-games-section" class="bg-white shadow-md rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Gestionar Partidos</h2>
                <button id="refresh-games-btn" 
                        class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition text-sm">
                    Refrescar Lista
                </button>
            </div>
            
            <div id="games-list-container" class="space-y-4">
                <p class="text-gray-500">Haz clic en "Refrescar Lista" para ver los partidos 'en curso' o 'próximos'.</p>
            </div>
        </div>
        
    </div>

    <script>
        // --- Constantes del DOM ---
        const team1Select = document.getElementById('team1-select');
        const team2Select = document.getElementById('team2-select');
        const createGameBtn = document.getElementById('create-game-btn');
        const alertContainer = document.getElementById('alert-container');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        
        // (NUEVAS) Constantes de Gestión
        const refreshGamesBtn = document.getElementById('refresh-games-btn');
        const gamesListContainer = document.getElementById('games-list-container');


        // --- Headers de Autenticación ---
        function getAuthHeaders() {
            const user = usernameInput.value;
            const pass = passwordInput.value;
            const basicAuth = 'Basic ' + btoa(user + ':' + pass);
            return {
                'Content-Type': 'application/json',
                'Authorization': basicAuth
            };
        }

        // --- Funciones API (Creación) ---
        
        async function loadTeams() {
            try {
                const response = await fetch('/manager/teams', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Error ${response.status}`);
                }
                const teams = await response.json(); 
                team1Select.innerHTML = '<option value="">Selecciona un equipo</option>';
                team2Select.innerHTML = '<option value="">Selecciona un equipo</option>';
                teams.forEach(team => {
                    const option1 = new Option(`${team.name} ${team.flag || ''}`, team.id);
                    const option2 = new Option(`${team.name} ${team.flag || ''}`, team.id);
                    team1Select.add(option1);
                    team2Select.add(option2);
                });
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        async function createGame() {
            const team1_id = team1Select.value;
            const team2_id = team2Select.value;
            if (!team1_id || !team2_id || team1_id === team2_id) {
                showAlert('Selecciona dos equipos diferentes.', 'warning');
                return;
            }
            // ... (resto de la lógica de createGame)
            createGameBtn.disabled = true;
            createGameBtn.textContent = 'Creando...';
            try {
                const response = await fetch('/manager/games', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ team1_id, team2_id })
                });
                const responseData = await response.json(); 
                if (!response.ok) throw new Error(responseData.detail || `Error ${response.status}`);
                
                showAlert(`Partido creado: ${responseData.team1_name} vs ${responseData.team2_name}`, 'success');
                team1Select.value = "";
                team2Select.value = "";
                loadActiveGames(); // Refrescar la lista de partidos después de crear uno
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                createGameBtn.disabled = false;
                createGameBtn.textContent = 'Crear Partido';
            }
        }

        // --- (NUEVAS) Funciones API (Gestión) ---

        async function loadActiveGames() {
            gamesListContainer.innerHTML = '<p class="text-gray-500">Cargando partidos...</p>';
            try {
                const response = await fetch('/manager/games/list', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                if (response.status === 401) throw new Error('Error de autenticación.');
                
                const responseData = await response.json();
                if (!response.ok) {
                    // El error de índice de Firestore vendrá aquí
                    if (responseData.detail.includes("index")) {
                        showAlert("Falta un índice en Firestore. Revisa la terminal de uvicorn, copia el link que te da Google y créalo.", 'danger');
                    }
                    throw new Error(responseData.detail || `Error ${response.status}`);
                }

                if (responseData.length === 0) {
                    gamesListContainer.innerHTML = '<p class="text-gray-500">No hay partidos activos o próximos.</p>';
                    return;
                }

                // Limpiar y renderizar tarjetas
                gamesListContainer.innerHTML = '';
                responseData.forEach(game => {
                    const gameCard = renderGameCard(game);
                    gamesListContainer.appendChild(gameCard);
                });

            } catch (error) {
                showAlert(error.message, 'danger');
                gamesListContainer.innerHTML = `<p class="text-red-500">Error al cargar partidos.</p>`;
            }
        }

        function renderGameCard(game) {
            const div = document.createElement('div');
            div.className = 'border border-gray-200 rounded-lg p-4 game-card';
            // Guardamos el game-id en la tarjeta misma
            div.dataset.gameId = game.id;
            
            div.innerHTML = `
                <h3 class="font-semibold text-lg">${game.team1_name} vs ${game.team2_name}</h3>
                <p class="text-sm text-gray-500 mb-4">Estado: ${game.status} (ID: ${game.id})</p>
                
                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Puntuar en Set N°:</label>
                    <input type-="number" value="1" 
                        class="set-number-input w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm mb-2">
                    
                    <div class="flex gap-4">
                        <button 
                            class="flex-1 bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600 score-btn"
                            data-scoring-team-id="${game.team1_id}">
                            +1 ${game.team1_name}
                        </button>
                        <button 
                            class="flex-1 bg-red-500 text-white py-2 px-3 rounded-md hover:bg-red-600 score-btn"
                            data-scoring-team-id="${game.team2_id}">
                            +1 ${game.team2_name}
                        </button>
                    </div>
                </div>

                <div class="border-t pt-4 mt-4">
                    <h4 class="font-medium text-gray-800 mb-2">Finalizar Set</h4>
                    <div class="flex gap-4">
                        <button 
                            class="flex-1 bg-yellow-500 text-white py-2 px-3 rounded-md hover:bg-yellow-600 finish-set-btn"
                            data-winner-team-id="${game.team1_id}">
                            Ganó ${game.team1_name}
                        </button>
                        <button 
                            class="flex-1 bg-yellow-500 text-white py-2 px-3 rounded-md hover:bg-yellow-600 finish-set-btn"
                            data-winner-team-id="${game.team2_id}">
                            Ganó ${game.team2_name}
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Usará el N° de Set de arriba. Esto creará el siguiente set.</p>
                </div>

                <div class="border-t pt-4 mt-4">
                    <h4 class="font-medium text-gray-800 mb-2">Finalizar Partido</h4>
                    <div class="flex gap-4">
                        <button 
                            class="flex-1 bg-gray-700 text-white py-2 px-3 rounded-md hover:bg-gray-800 finish-game-btn"
                            data-winner-team-id="${game.team1_id}">
                            Ganó ${game.team1_name}
                        </button>
                        <button 
                            class="flex-1 bg-gray-700 text-white py-2 px-3 rounded-md hover:bg-gray-800 finish-game-btn"
                            data-winner-team-id="${game.team2_id}">
                            Ganó ${game.team2_name}
                        </button>
                    </div>
                </div>
            `;
            return div;
        }

        function findCardAndSetNumber(button) {
            const card = button.closest('.game-card');
            if (!card) return null;

            const gameId = card.dataset.gameId;
            const setInput = card.querySelector('.set-number-input');
            const setNumber = parseInt(setInput.value, 10);

            if (!gameId || isNaN(setNumber) || setNumber <= 0) {
                showAlert('Error: No se encontró el ID del partido o el N° de Set es inválido.', 'danger');
                return null;
            }
            return { card, gameId, setNumber };
        }

        async function handleScorePoint(button) {
            const { card, gameId, setNumber } = findCardAndSetNumber(button);
            if (!card) return;
            
            const scoringTeamId = button.dataset.scoringTeamId;
            if (!scoringTeamId) return;

            button.disabled = true;
            button.textContent = 'Anotando...';

            const body = JSON.stringify({
                set_number: setNumber,
                scoring_team_id: scoringTeamId
            });

            try {
                const response = await fetch(`/manager/games/${gameId}/increment`, {
                    method: 'POST', headers: getAuthHeaders(), body: body
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.detail || `Error ${response.status}`);
                
                showAlert(`Punto (Set ${setNumber}): ${responseData.team1_score_after} - ${responseData.team2_score_after}`, 'success');
            
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                button.disabled = false;
                button.textContent = button.textContent.replace('Anotando...', `+1 ...`);
            }
        }

        async function handleFinishSet(button) {
            const { card, gameId, setNumber } = findCardAndSetNumber(button);
            if (!card) return;

            const winnerTeamId = button.dataset.winnerTeamId;
            if (!winnerTeamId) return;

            if (!confirm(`¿Seguro que quieres finalizar el Set ${setNumber} con ganador ${winnerTeamId}? Esto creará el Set ${setNumber + 1}.`)) {
                return;
            }

            button.disabled = true;
            button.textContent = 'Finalizando...';

            const body = JSON.stringify({
                set_number: setNumber,
                winner_team_id: winnerTeamId
            });

            try {
                const response = await fetch(`/manager/games/${gameId}/finish_set`, {
                    method: 'POST', headers: getAuthHeaders(), body: body
                });
                const responseData = await response.json(); // responseData es el *nuevo* set
                if (!response.ok) throw new Error(responseData.detail || `Error ${response.status}`);
                
                showAlert(`Set ${setNumber} finalizado. Creado Set ${responseData.set_number}.`, 'success');
                
                // Actualizamos el input al nuevo número de set
                const setInput = card.querySelector('.set-number-input');
                setInput.value = responseData.set_number;

            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                button.disabled = false;
                button.textContent = button.textContent.replace('Finalizando...', 'Ganó...');
            }
        }

        async function handleFinishGame(button) {
            const card = button.closest('.game-card');
            if (!card) return;
            const gameId = card.dataset.gameId;
            
            const winnerTeamId = button.dataset.winnerTeamId;
            if (!winnerTeamId) return;

            if (!confirm(`¿¡SEGURO!? ¿Quieres finalizar TODO el partido ${gameId} con ganador ${winnerTeamId}? Esta acción no se puede deshacer.`)) {
                return;
            }

            button.disabled = true;
            button.textContent = 'Finalizando...';

            const body = JSON.stringify({
                winner_team_id: winnerTeamId
            });

            try {
                const response = await fetch(`/manager/games/${gameId}/finish_game`, {
                    method: 'POST', headers: getAuthHeaders(), body: body
                });
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.detail || `Error ${response.status}`);
                
                showAlert(`¡Partido ${gameId} finalizado!`, 'success');
                
                // El partido terminó, lo sacamos de la lista
                card.remove();

            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                // No necesitamos re-habilitar el botón porque la tarjeta se elimina
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', loadTeams);
        createGameBtn.addEventListener('click', createGame);
        refreshGamesBtn.addEventListener('click', loadActiveGames);

        gamesListContainer.addEventListener('click', (event) => {
            const button = event.target.closest('button'); // Encuentra el botón más cercano
            if (!button) return;

            if (button.classList.contains('score-btn')) {
                handleScorePoint(button);
                return;
            }
            if (button.classList.contains('finish-set-btn')) {
                handleFinishSet(button);
                return;
            }
            if (button.classList.contains('finish-game-btn')) {
                handleFinishGame(button);
                return;
            }
        });

        function showAlert(message, type = 'info') {
            // (Mismo código de alertas que antes)
            let bgColor, borderColor, textColor;
            switch (type) {
                case 'success': bgColor = 'bg-green-100'; borderColor = 'border-green-400'; textColor = 'text-green-700'; break;
                case 'danger': bgColor = 'bg-red-100'; borderColor = 'border-red-400'; textColor = 'text-red-700'; break;
                case 'warning': bgColor = 'bg-yellow-100'; borderColor = 'border-yellow-400'; textColor = 'text-yellow-700'; break;
                default: bgColor = 'bg-blue-100'; borderColor = 'border-blue-400'; textColor = 'text-blue-700'; break;
            }
            const alertDiv = document.createElement('div');
            alertDiv.className = `${bgColor} ${borderColor} ${textColor} border px-4 py-3 rounded relative`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `<span class="block sm:inline">${message}</span><span class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.remove();"><svg class="fill-current h-6 w-6 ${textColor}" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Cerrar</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l3.029-2.651-3.03-2.651a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.03a1.2 1.2 0 1 1 1.697 1.697l-3.03 2.651 3.03 2.651a1.2 1.2 0 0 1 0 1.698z"/></svg></span>`;
            alertContainer.innerHTML = ''; 
            alertContainer.append(alertDiv);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', loadTeams);
        createGameBtn.addEventListener('click', createGame);
        
        refreshGamesBtn.addEventListener('click', loadActiveGames);
        // Usamos delegación de eventos para manejar clics en botones de score
        gamesListContainer.addEventListener('click', handleScorePoint);

    </script>
</body>
</html>