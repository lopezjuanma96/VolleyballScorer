<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partido en Vivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <style>
        .tab-btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .tab-btn.inactive { background-color: #f3f4f6; color: #4b5563; }
        .tab-btn.active { background-color: #3b82f6; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-btn.cancelled { background-color: #fecaca; color: #b91c1c; text-decoration: line-through; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-3xl p-4 mt-4 lg:mt-10">

        <div class="bg-white shadow-xl rounded-xl p-6">
            
            <div id="game-header" class="text-center mb-6">
                
                <div class="flex justify-between items-center mb-4">
                    <span id="category-label" class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">Categoría</span>
                    <p id="game-status" class="text-sm font-bold text-red-600 animate-pulse">● EN VIVO</p>
                </div>
                
                <div class="flex justify-around items-start">
                    <div class="w-1/3 flex flex-col items-center">
                        <img id="team1-flag" src="/static/no_flag.png" class="w-16 h-16 lg:w-20 lg:h-20 rounded-full object-cover border-2 border-white shadow-md mb-2">
                        <h2 id="team-1-name" class="text-xl lg:text-2xl font-bold text-gray-800 leading-tight">...</h2>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span id="team-1-score" class="text-5xl lg:text-6xl font-black text-blue-600">0</span>
                            <span class="text-xl font-bold text-gray-400">(<span id="sets1">0</span>)</span>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <span class="text-2xl font-light text-gray-300">vs</span>
                    </div>
                    
                    <div class="w-1/3 flex flex-col items-center">
                        <img id="team2-flag" src="/static/no_flag.png" class="w-16 h-16 lg:w-20 lg:h-20 rounded-full object-cover border-2 border-white shadow-md mb-2">
                        <h2 id="team-2-name" class="text-xl lg:text-2xl font-bold text-gray-800 leading-tight">...</h2>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span id="team-2-score" class="text-5xl lg:text-6xl font-black text-blue-600">0</span>
                            <span class="text-xl font-bold text-gray-400">(<span id="sets2">0</span>)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sets-tabs-container" class="flex flex-wrap gap-2 border-b border-gray-200 pb-4 mb-4 overflow-x-auto">
                <span class="text-sm text-gray-400">Cargando sets...</span>
            </div>

            <div>
                <div class="overflow-hidden border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th id="points-header-team1" class="w-2/5 px-4 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">...</th>
                                <th class="w-1/5 px-4 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Pto</th>
                                <th id="points-header-team2" class="w-2/5 px-4 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">...</th>
                            </tr>
                        </thead>
                        <tbody id="points-history-list" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="3" class="px-4 py-8 text-sm text-center text-gray-400">Selecciona un set para ver el historial</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-6">
            <a href="/" class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium transition">
                &larr; Volver al Lobby
            </a>
        </div>
    </div>

    <script>
        // --- 1. Configuración de Firebase Cliente ---
        const firebaseConfig = {
            apiKey: "AIzaSyCY9IXzvj6KDaNqbRMXOZ4obnw5mIJKeZs",
            authDomain: "volleyballscorer.firebaseapp.com",
            projectId: "volleyballscorer",
            storageBucket: "volleyballscorer.firebasestorage.app",
            messagingSenderId: "358310788461",
            appId: "1:358310788461:web:3eb5012f9a9d34d6896e64"
        };

        // --- 2. Inicializar Firebase ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('id');

        // Helper
        const getFlag = (url) => url ? url : '/static/no_flag.png';

        // Refs DOM
        const el = {
            catLabel: document.getElementById('category-label'),
            team1Name: document.getElementById('team-1-name'), team2Name: document.getElementById('team-2-name'),
            team1Flag: document.getElementById('team1-flag'), team2Flag: document.getElementById('team2-flag'),
            team1Score: document.getElementById('team-1-score'), team2Score: document.getElementById('team-2-score'),
            sets1: document.getElementById('sets1'), sets2: document.getElementById('sets2'),
            gameStatus: document.getElementById('game-status'),
            setsTabsContainer: document.getElementById('sets-tabs-container'),
            pointsList: document.getElementById('points-history-list'),
            pointsHeaderTeam1: document.getElementById('points-header-team1'), pointsHeaderTeam2: document.getElementById('points-header-team2')
        };
        
        let gameDataCache = {}; 
        let setsDataCache = new Map(); 
        let currentPointsListener = null; 
        let activeSetNumber = null;

        if (!gameId) document.body.innerHTML = '<h1 class="text-center mt-10 text-red-600">ID no encontrado</h1>';
        else {
            // Listener 1: Game Doc
            db.collection("games").doc(gameId).onSnapshot((snap) => {
                if (!snap.exists) return;
                gameDataCache = snap.data();
                
                // Render Header
                el.catLabel.innerText = gameDataCache.category_name || 'General';
                
                el.team1Name.innerText = gameDataCache.team1_name;
                el.team1Flag.src = getFlag(gameDataCache.team1_flag);
                
                el.team2Name.innerText = gameDataCache.team2_name;
                el.team2Flag.src = getFlag(gameDataCache.team2_flag);

                el.team1Score.innerText = gameDataCache.current_team1_score;
                el.team2Score.innerText = gameDataCache.current_team2_score;
                
                // Sets Won (Fallback a 0)
                el.sets1.innerText = gameDataCache.team1_sets_won || 0;
                el.sets2.innerText = gameDataCache.team2_sets_won || 0;

                el.pointsHeaderTeam1.innerText = gameDataCache.team1_name;
                el.pointsHeaderTeam2.innerText = gameDataCache.team2_name;

                if (gameDataCache.status === 'live') {
                    el.gameStatus.innerText = `● EN VIVO (Set ${gameDataCache.current_set_number})`;
                    el.gameStatus.className = "text-sm font-bold text-red-600 animate-pulse";
                } else if (gameDataCache.status === 'finished') {
                    const winner = (gameDataCache.winner_id === gameDataCache.team1_id) ? gameDataCache.team1_name : gameDataCache.team2_name;
                    el.gameStatus.innerText = `FINALIZADO (Ganó ${winner})`;
                    el.gameStatus.className = "text-sm font-bold text-gray-600";
                } else {
                    el.gameStatus.innerText = "PRÓXIMO";
                    el.gameStatus.className = "text-sm font-bold text-blue-600";
                }
            });

            // Listener 2: Sets (Igual que v0.2)
            db.collection("games").doc(gameId).collection("sets").orderBy("set_number").onSnapshot((snap) => {
                el.setsTabsContainer.innerHTML = ''; setsDataCache.clear();
                let latestLiveSet = null; let lastSetNumber = null;

                if (snap.empty) { el.setsTabsContainer.innerHTML = '<span class="text-xs text-gray-400">Esperando sets...</span>'; return; }

                snap.forEach((doc) => {
                    const d = doc.data(); const sNum = doc.id;
                    setsDataCache.set(sNum, d);
                    const tab = document.createElement('button');
                    tab.className = 'tab-btn inactive whitespace-nowrap';
                    tab.dataset.setNumber = sNum;
                    
                    if (d.status === 'finished') tab.innerText = `Set ${d.set_number}: ${d.team1_current_score}-${d.team2_current_score}`;
                    else if (d.status === 'live') { tab.innerText = `Set ${d.set_number} (Vivo)`; latestLiveSet = sNum; }
                    else if (d.status === 'cancelled') { tab.innerText = `Set ${d.set_number} (Anulado)`; tab.classList.add('cancelled'); }
                    
                    tab.addEventListener('click', () => handleTabClick(sNum));
                    el.setsTabsContainer.appendChild(tab);
                    lastSetNumber = sNum;
                });
                
                const toActivate = latestLiveSet || activeSetNumber || lastSetNumber;
                handleTabClick(toActivate);
            });
        }

        function handleTabClick(setNumber) {
            if (activeSetNumber === setNumber && currentPointsListener) return;
            activeSetNumber = setNumber;
            Array.from(el.setsTabsContainer.children).forEach(tab => {
                if (tab.dataset.setNumber === setNumber) { tab.classList.remove('inactive'); tab.classList.add('active'); } 
                else { tab.classList.remove('active'); tab.classList.add('inactive'); }
            });
            listenToPoints(setNumber);
        }

        function listenToPoints(setNumber) {
            if (currentPointsListener) currentPointsListener();
            const sData = setsDataCache.get(setNumber);
            
            if (!sData || sData.status === 'cancelled') {
                 el.pointsList.innerHTML = '<tr><td colspan="3" class="py-8 text-center text-gray-400 italic">Sin datos o set anulado</td></tr>'; return;
            }

            el.pointsList.innerHTML = '<tr><td colspan="3" class="py-8 text-center text-gray-400">Cargando...</td></tr>';
            
            currentPointsListener = db.collection("games").doc(gameId).collection("sets").doc(setNumber).collection("points")
              .orderBy("timestamp", "desc")
              .onSnapshot((snap) => {
                  if (snap.empty) { el.pointsList.innerHTML = '<tr><td colspan="3" class="py-8 text-center text-gray-400">0 - 0</td></tr>'; return; }
                  el.pointsList.innerHTML = '';
                  snap.forEach((doc) => {
                      const p = doc.data();
                      const tr = document.createElement('tr');
                      
                      let c1 = "py-3 px-4 text-lg font-bold text-gray-800 text-center";
                      let c2 = "py-3 px-4 text-lg font-bold text-gray-800 text-center";
                      let arrow = "";
                      
                      if (p.scoring_team_id === gameDataCache.team1_id) { c1 += " bg-yellow-100"; arrow = "←"; }
                      else if (p.scoring_team_id === gameDataCache.team2_id) { c2 += " bg-yellow-100"; arrow = "→"; }
                      
                      tr.innerHTML = `<td class="${c1}">${p.team1_score_after}</td><td class="text-gray-400 text-center text-sm">${arrow}</td><td class="${c2}">${p.team2_score_after}</td>`;
                      el.pointsList.appendChild(tr);
                  });
              });
        }
    </script>
</body>
</html>